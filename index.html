<!DOCTYPE HTML><html>
<head>
  <meta charset="UTF-8"><title>AquaMeter Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <style>
    body { font-family: -apple-system, sans-serif; background: #f0f4f8; margin: 0; padding: 0; color: #2c3e50; text-align: center; }
    .card { max-width: 450px; margin: 10px auto; background: #fff; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    .tabs { display: flex; background: #eee; border-radius: 12px; margin-bottom: 20px; overflow: hidden; }
    .tab-btn { flex: 1; padding: 12px; border: none; background: #eee; cursor: pointer; font-weight: bold; }
    .tab-btn.active { background: #2196f3; color: #fff; }
    .tab-content { display: none; } .tab-content.active { display: block; }
    #v-lit { font-size: 2.8rem; font-weight: 800; color: #2196f3; margin: 10px 0; display: block; }
    .prog-bg { background: #eee; border-radius: 10px; height: 35px; position: relative; overflow: hidden; margin: 15px 0; border: 1px solid #ddd; }
    .prog-bar { background: #2196f3; height: 100%; width: 0%; transition: 0.8s; }
    .prog-text { position: absolute; width: 100%; top: 7px; font-weight: bold; font-size: 1.1rem; color: #000; left:0; text-align:center; }
    .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
    .data-item { background: #f8f9fa; padding: 12px; border-radius: 15px; border: 1px solid #eee; }
    .label { font-size: 0.75rem; color: #888; text-transform: uppercase; font-weight: bold; }
    .btn-blue { background: #2196f3; color: white; margin-bottom: 10px; width: 100%; }
    .btn-green { background: #2ecc71; color: white; width: 100%; }
    .btn-orange { background: #f39c12; color: white; width: 100%; }
    svg { background: #fcfcfc; border-radius: 15px; width: 100%; height: 200px; margin-top: 10px; }
    .bar-svg { fill: #2196f3; rx: 3; }
  </style>
</head>
<body>
  <div class="card">
    <div id="status" style="color:#e74c3c; font-size: 12px; margin-bottom: 5px;">DISCONNECTED üî¥</div>
    <button id="btn-connect" class="btn-blue" onclick="handleConnect()">CONNECT AQUAMETER</button>

    <div class="tabs">
      <button class="tab-btn active" onclick="openTab('main', this)">DASH</button>
      <button class="tab-btn" onclick="openTab('hist', this)">HIST</button>
      <button class="tab-btn" onclick="openTab('sett', this)">‚öôÔ∏è</button>
    </div>

    <div id="main" class="tab-content active">
        <span id="v-lit">0.00</span><span class="label">–õ–ò–¢–†–û–í –û–°–¢–ê–õ–û–°–¨</span>
        <div class="prog-bg"><div id="bar" class="prog-bar"></div><div id="perc" class="prog-text">0.00%</div></div>
        <div class="data-grid">
          <div class="data-item"><span class="label">–°–ï–ì–û–î–ù–Ø</span><br><span id="use" style="font-weight:bold">0.0</span> L</div>
          <div class="data-item"><span class="label">–ü–û–¢–û–ö</span><br><span id="flow" style="font-weight:bold">0.0</span> l/m</div>
        </div>
        <button class="btn-green" onclick="if(confirm('Full tank?')) send('FULL')">–ü–û–õ–ù–´–ô –ë–ê–ö</button>
      </div>

    <div id="hist" class="tab-content">
      <h3>–†–ê–°–•–û–î (7 –î–ù–ï–ô)</h3>
      <svg id="svg-graph" viewBox="0 0 350 200"></svg>
    </div>

    <div id="sett" class="tab-content">
      <button class="btn-orange" onclick="send('CAL_START')">START CALIBRATION (1L)</button>
      <div id="cal-box" style="display:none; background:#fff3cd; padding:15px; border-radius:15px; margin-top:10px;">
        –ò–ú–ü–£–õ–¨–°–û–í: <span id="cal-p" style="font-weight:bold">0</span>
        <button class="btn-green" style="margin-top:10px" onclick="send('CAL_STOP')">DONE (1L)</button>
      </div>
    </div>
  </div>

  <script>
    let charRX, charTX, hData = [0,0,0,0,0,0,0], curLang = 2;
    const SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';

    const openTab = (id, btn) => {
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      btn.classList.add('active');
      if(id === 'hist') drawGraph();
    };

    async function handleConnect() {
      try {
        // 1. –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —É–∂–µ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        const devices = await navigator.bluetooth.getDevices();
        let device = devices.find(d => d.name === 'AquaMeter_Pro');
        
        if (!device) {
          console.log("No known device found, requesting new...");
          // 2. –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ - –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º (—ç—Ç–æ –≤—ã–∑–æ–≤–µ—Ç —Å–ø–∏—Å–æ–∫ –æ–¥–∏–Ω —Ä–∞–∑)
          device = await navigator.bluetooth.requestDevice({
            filters: [{ name: 'AquaMeter_Pro' }],
            optionalServices: [SERVICE_UUID]
          });
        }
        
        await startDevice(device);
      } catch (err) {
        console.log("Connect error: " + err);
        // –†–µ–∑–µ—Ä–≤–Ω—ã–π –∑–∞–ø—É—Å–∫ —Å–ø–∏—Å–∫–∞, –µ—Å–ª–∏ getDevices —Å–æ–≤—Å–µ–º –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª
        const device = await navigator.bluetooth.requestDevice({
            filters: [{ name: 'AquaMeter_Pro' }],
            optionalServices: [SERVICE_UUID]
        });
        await startDevice(device);
      }
    }

    async function startDevice(device) {
      document.getElementById('status').innerText = "CONNECTING... üü°";
      const server = await device.gatt.connect();
      const service = await server.getPrimaryService(SERVICE_UUID);
      charRX = await service.getCharacteristic('6e400002-b5a3-f393-e0a9-e50e24dcca9e');
      charTX = await service.getCharacteristic('6e400003-b5a3-f393-e0a9-e50e24dcca9e');
      
      await charTX.startNotifications();
      charTX.addEventListener('characteristicvaluechanged', (e) => {
        const d = new TextDecoder().decode(e.target.value).split('|');
        if(d.length < 8) return;
        document.getElementById('v-lit').innerText = d[0];
        document.getElementById('use').innerText = d[4];
        document.getElementById('flow').innerText = d[3];
        let p = (parseFloat(d[0]) / parseFloat(d[1]) * 100);
        document.getElementById('perc').innerText = p.toFixed(1) + "%";
        document.getElementById('bar').style.width = (p > 100 ? 100 : p) + "%";
        document.getElementById('bar').style.background = (parseFloat(d[0]) <= parseFloat(d[2])) ? "#e74c3c" : "#2196f3";
        if(d[5] === "1") {
           document.getElementById('cal-box').style.display = 'block';
           document.getElementById('cal-p').innerText = d[6];
        } else { document.getElementById('cal-box').style.display = 'none'; }
        if(d[8]) hData = d[8].split(',').map(Number);
      });
      
      send("SYNC " + new Date().getDay());
      document.getElementById('status').innerText = "CONNECTED üü¢";
      document.getElementById('btn-connect').style.display = "none";

      device.addEventListener('gattserverdisconnected', () => {
        document.getElementById('status').innerText = "DISCONNECTED üî¥";
        document.getElementById('btn-connect').style.display = "block";
      });
    }

    async function send(msg) {
      if(!charRX) return;
      await charRX.writeValue(new TextEncoder().encode(msg));
    }

    function drawGraph() {
      const svg = document.getElementById('svg-graph'); const maxV = Math.max(...hData, 5); let html = '';
      for(let i=0; i<7; i++) {
        let h = (hData[i] / maxV) * 150; let x = 10 + (i * 48);
        html += `<rect x="${x}" y="${170-h}" width="35" height="${h}" class="bar-svg" />`;
        html += `<text x="${x}" y="${165-h}" style="font-size:10px; font-weight:bold">${hData[i].toFixed(1)}</text>`;
      }
      svg.innerHTML = html;
    }
  </script>
</body>
</html>
